# IFU 子模块 ifuUncacheUnit

## 功能描述

### 功能描述
uncache模块主要负责从uncache总线提取指令，同时负责判断阻止MMIO指令的推测执行。受PBMT属性的影响，部分非缓存的指令数据是允许推测执行的，因此需要对MMIO指令进行特殊区分。需要强调一点的是，uncache的指令数据来自于s3级，因此任何在S1、S2级依赖指令数据计算出来的结果，都值得重新审视。

uncache本身不处理跨页的情况下，当遇到uncache指令跨页时将分为两个预测块进行处理。这与cache指令跨页的处理情况有些类似。uncache需要什么？uncache需要物理地址，用于向uncache总线发出取指请求。uncache需要ftqIdx，以便向FTQ请求查询预测块的提交状态用于处理MMIO的阻塞逻辑。uncache还需要pmp的结果和PBMT的结果，用于确认当前的uncache请求是否是需要进行推测阻塞的MMIO请求。需要注意的是对于处理器执行的第一条指令，其不存在更旧的指令，我们将越过阻塞机制直接向uncache总线发出取指请求。

需要注意的是对于uncache总线，它每次总是返回64字节对齐的数据，这意味着如果指令跨越了64字节的边界，将会发送两次请求，这个由前端的uncache通路完成，IFU对此无感。区别在于，当指令跨页时，理论上可能存在两个页的物理地址不连续，前端的uncache通路，将无力进行发送两次请求，它会返回crossPage的状态标志，这需要IFU做额外的拼接处理。

### uncache指令的处理流程
-   第一步：uncache状态机接收来自IFU的uncache请求，判断是否为非MMIO。如果是非MMIO直接向uncache通路发送请求并转第三步，否则等待MMIO指令成为最旧指令并转第二步。
-   第二步：如果MMIO指令是处理器执行的第一条指令或者MMIO指令是最旧指令，则转第三步，否则持续在第二步进行等待。
-   第三步：如果uncache通道接收了请求，则转第四步，否则继续在第三步等待。
-   第四步：如果接收到uncache通道的返回数据，uncache子模块将会把数据回传到IFU的主体，转IFU主体进行处理。否则继续在第四步中进行等待。
-   无条件冲刷：uncache子模块接收到Flush信号后，不管处于第几步都将复位所有的控制寄存器。不考虑uncache通道是否处理完毕，因为uncache通道也会接收到Flush信号。

### ifu接收uncache子模块信息处理
IFU主体在接收到uncache子模块的信息后，将会根据是否跨页分为两种情况处理：
-   跨页情况下：1. 如果预测器给出的结果是顺序取指，IFU主体将暂存这半截的指令数据信息，等待下一个预测块继续走完uncache子模块流程。拼接两个预测块的指令数据。2.如果预测器给出的结果是跳转，IFU同样将暂存这半截的指令数据信息，但是会直接发送重定向，从而达到从正确的下一个预测块获得的另外半截数据。
-   非跨页情况下：一条指令在一个预测块中取完。
-   目前IFU在完成一条uncache的取指后，不管预测器是否给出顺序执行都会发送重定向要求顺序执行。如果对uncache取指有有速度的需求，这是可能的后续优化点。

### 整体框图
![uncache结构](../figure/IFU/uncache_fsm.svg)